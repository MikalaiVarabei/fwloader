# fwloader
Firmware Upgrade App. Qt project.


Формат команд.
Все команды имеют одинаковый вид, представленный в Таблице:

| Порядковый номер поля | Название поля | Размер поля, байт | Описание |
| ----- | ----- | :---- | :---- |
| 1 | Префикс | 1 | Поле является маркером начала сообщения Входящие в устройство сообщения должны иметь префикс ACh, а исходящие сообщения будут выдаваться с префиксом ADh |
| 2 | Сетевой адрес | 1 | Для префикса ACh сетевой адрес получателя сообщения Для префикса ADh сетевой адрес отправителя сообщения |
| 3 | Код операции | 1 | Для префикса ACh код операции, которую устройство должно выполнить Для префикса ADh код операции, на которую выдаётся ответ |
| 4 | Количество байт | 1..255 | Количество последующих байт |
| 5 | Данные | Зависит от кода операции | Состав данных и формат поля зависит от кода операции |
| 6 | Контрольная сумма | 1 | Поле используется для контроля целостности данных предыдущих полей |

Запрос информации о системе (команда F1h)

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ACh | Префикс |
| 1 | 1 | 56h | Сетевой адрес получателя |
| 2 | 1 | F1h | Код операции |
| 3 | 1 | 1 | Количество последующих байт |
| 4 | 1 | 00h...FFh | Контрольная сумма |

Формат ответа:

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ADh | Префикс |
| 1 | 1 | 56h | Сетевой адрес отправителя |
| 2 | 1 | F1h | Код операции |
| 3 | 1 | 11 | Количество последующих байт |
| 4 | 1 | 'B' | ID (название) устройства 'B' |
| 5 | 1 | 'O' | ID (название) устройства 'O' |
| 6 | 1 | 'O' | ID (название) устройства 'O' |
| 7 | 1 | 'T' | ID (название) устройства 'T' |
| 8 | 2 | 0000h..FFFFh | Версия протокола |
| 10 | 2 | 0000h..FFFFh | Версия Software |
| 12 | 2 | 0000h..FFFFh | Версия Hardware |
| 14 | 1 | 00h...FFh | Контрольная сумма |

Перейти в режим бутлоадера (команда F2h)  
Команда переводит устройство из режима работы в режим бутлоадера.  
Из режима бутлоадера не доступны команды режима работы, все выходы переводятся в состояние по умолчанию.  
Формат команды:

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ACh | Префикс |
| 1 | 1 | 56h | Сетевой адрес получателя |
| 2 | 1 | F2h | Код операции |
| 3 | 1 | 1 | Количество последующих байт |
| 4 | 1 | 00h...FFh | 0x0B перейти в бутлоадер 0x0A перейти в приложение |
| 5 | 1 | 00h...FFh | Контрольная сумма |

Формат ответа:

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ADh | Префикс |
| 1 | 1 | 56h | Сетевой адрес отправителя |
| 2 | 1 | F2h | Код операции |
| 3 | 1 | 2 | Количество последующих байт |
| 4 | 1 | 00h...FFh | 0x0B ответ из бутлоадера 0x0A ответ из приложения |
| 5 | 1 | 00h…FFh | Контрольная сумма |

Очистить флешь память (команда F3h)  
Перед очисткой памяти необходимо отправить команду разблокировки.  
Формат команды:

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ACh | Префикс |
| 1 | 1 | 56h | Сетевой адрес получателя |
| 2 | 1 | F3h | Код операции |
| 3 | 1 | 2 | Количество последующих байт |
| 4 | 1 | 00h...FFh | 0x01 запросить состояние 0x02 разблокировать 0x03 очистить 0x04 проверить целостность управляющей программы 0x05 произвести сброс и перейти к управляющей программе |
| 5 | 1 | 00h...FFh | Контрольная сумма |

Формат ответа:

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ADh | Префикс |
| 1 | 1 | 56h | Сетевой адрес отправителя |
| 2 | 1 | F3h | Код операции |
| 3 | 1 | 2 | Количество последующих байт |
| 4 | 1 | 00h...FFh | 0x01 заблокировано 0x02 разблокировано 0x43 очистка \- ошибка 0x03 очистка завершена 0x04 целостность управляющей программы \- ок 0x44 целостность управляющей программы \- ошибка 0x05 переход к управляющей программе \- ок 0x45 переход к управляющей программе \- ошибка примечание: бит 7 \- команда принята, в процессе выполнения бит 6 \- при выполнении команды возникла ошибка |
| 5 | 1 | 00h…FFh | Контрольная сумма |

Запись программы (команда F4h)  
Запись производится блоками по 32 байта, если данных меньше, то не занятые байты заполняются 0xFF.  
Адрес первого блока начинается с 0, второго с  32, третьего с  64 и т.д.  
Если ответ не был получен, команду нужно отправить повторно.  
Формат команды:

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ACh | Префикс |
| 1 | 1 | 56h | Сетевой адрес получателя |
| 2 | 1 | F4h | Код операции |
| 3 | 1 | 36 | Количество последующих байт |
| 4 | 1 | 00h...FFh | Адрес записи старший байт |
| 5 | 1 | 00h...FFh | Адрес записи средний байт |
| 6 | 1 | 00h...FFh | Адрес записи младший байт |
| 7 | 1 | 00h...FFh | 0 байт данных |
| 7+n | 1 | 00h...FFh | n байт данных |
| 38 | 1 | 00h...FFh | 31 байт данных |
| 39 | 1 | 00h...FFh | Контрольная сумма |

Формат ответа:

| Смещение, байт | Размер поля, байт | Значение | Описание |
| ----- | ----- | :---- | :---- |
| 0 | 1 | ADh | Префикс |
| 1 | 1 | 56h | Сетевой адрес отправителя |
| 2 | 1 | F4h | Код операции |
| 3 | 1 | 5 | Количество последующих байт |
| 4 | 1 | 00h...FFh | Адрес записи старший байт |
| 5 | 1 | 00h...FFh | Адрес записи средний байт |
| 6 | 1 | 00h...FFh | Адрес записи младший байт |
| 7 | 1 | 00h...FFh | 0x01 успешно 0x02 ошибка \- не верно задан адрес 0x03 ошибка \- данные не записаны 0x04 ошибка \- память не очищена 0x05 ошибка \- цифровая подпись не совпала 0x06 команда принята, в процессе выполнения (необходимо отправить команду повторно) |
| 8 | 1 | 00h…FFh | Контрольная сумма |






